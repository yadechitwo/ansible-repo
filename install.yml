- name: Initialize Server
  hosts: webservers
  user: admin
  become: yes
  vars:
    PHP_VERSION: 7.4.3
    DEST_DIR: space/www/testing.eroolaconsulting.com/data/current/web/
    LOG_DIR: space/logs/apache/testing.eroolaconsulting.com/php
    USER: admin
  tasks:
    - include_vars:
        file: vars.yml
    - name : install dependencies before starting
      apt:
        name: 
          - nodejs
          - npm
          - git
          
          - rsync
          - docker
          - php-mysql 
          - php-xml 
          - php-gd
          - libapache2-mod-wsgi
          - libapache2-mod-php 
          - php-curl
        state: latest
        update_cache: yes
    - name: install php related packages
      apt:
        name:
          - php={{PHP_VERSION}}
          - php-mysql={{PHP_VERSION}} 
          - php-xml={{PHP_VERSION}}
          - php-gd={{PHP_VERSION}}
          - php-curl={{PHP_VERSION}}
          - libapache2-mod-wsgi
          - libapache2-mod-php 
        state: installed
        update_cache: yes
    - name: Install Angular
      shell:
        "npm install -g @angular/cli"

    - name: Install Composer
      shell: |
        curl -sS https://getcomposer.org/installer -o composer-setup.php
        sudo php composer-setup.php --install-dir=/usr/bin --filename=composer
        sudo php composer-setup.php --install-dir=/usr/local/composer --filename=phpcomposer
        echo 'export PATH="$PATH:/usr/local/composer"' >> ~/.bashrc

    - name: Create document root if not exists
      file: 
        path: "{{ item }}"
        state: directory
        owner: admin
        group: admin
        mode: 0755
      loop:
        - "{{ DEST_DIR }}"
        - "{{ LOG_DIR }}"
    
    - name: Set up Apache virtuahHost
      template:
        src: "apache-conf/apache2.conf"
        dest: "/etc/apache2/sites-available/testing.eroolaconsulting.com"

    - name: create index file port 80 
      copy:
        content: "Hello wolrd"
        dest: "{{ DEST_DIR }}/index.html"